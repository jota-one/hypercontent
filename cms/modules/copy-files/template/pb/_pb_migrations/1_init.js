migrate(db => {
  // create initial superadmin user
  const dao = new Dao(db)

  const admin = new Admin()
  admin.email = 'juniors@jota.one'
  admin.setPassword('blablablabla')
  dao.saveAdmin(admin)

  // create CMS tables
  const collectionDefs = [
    {
      id: '7rhu87z0qx1hq88',
      name: 'HcConfigs',
      type: 'base',
      system: false,
      schema: [
        {
          system: false,
          id: 'abjoe2k8',
          name: 'value',
          type: 'json',
          required: true,
          presentable: false,
          unique: false,
          options: {
            maxSize: 2000000,
          },
        },
        {
          system: false,
          id: 'smouaeq3',
          name: 'key',
          type: 'text',
          required: true,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '[a-z0-9-_\\.]+',
          },
        },
      ],
      indexes: [],
      listRule: null,
      viewRule: null,
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {},
    },
    {
      id: 'br1inx9nr82mah7',
      name: 'HcContents',
      type: 'base',
      system: false,
      schema: [
        {
          system: false,
          id: 'bvd0cx34',
          name: 'blocks',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 2000000,
          },
        },
        {
          system: false,
          id: 'r5e3m3ni',
          name: 'state',
          type: 'select',
          required: true,
          presentable: false,
          unique: false,
          options: {
            maxSelect: 1,
            values: ['draft', 'published', 'backup'],
          },
        },
        {
          system: false,
          id: 'wd8zqlae',
          name: 'editorVersion',
          type: 'text',
          required: true,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '\\d+\\.\\d+\\d\\.\\d+',
          },
        },
        {
          system: false,
          id: 'jv3frsrt',
          name: 'name',
          type: 'text',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
      ],
      indexes: [],
      listRule: '',
      viewRule: '',
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {},
    },
    {
      id: 'io4ai0v08gkmmln',
      name: 'HcLabels',
      type: 'base',
      system: false,
      schema: [
        {
          system: false,
          id: 'ibe3zb8y',
          name: 'key',
          type: 'text',
          required: true,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
        {
          system: false,
          id: '9qha72a6',
          name: 'value',
          type: 'text',
          required: true,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
        {
          system: false,
          id: 'ztu7rm4j',
          name: 'Lang',
          type: 'relation',
          required: true,
          presentable: false,
          unique: false,
          options: {
            collectionId: '09zlcfzxr29yom7',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: [],
          },
        },
      ],
      indexes: [],
      listRule: '',
      viewRule: '',
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {},
    },
    {
      id: '09zlcfzxr29yom7',
      name: 'HcLangs',
      type: 'base',
      system: false,
      schema: [
        {
          system: false,
          id: 'gbazeuwm',
          name: 'code',
          type: 'text',
          required: true,
          presentable: false,
          unique: false,
          options: {
            min: 2,
            max: 5,
            pattern: '[a-z]{2}',
          },
        },
        {
          system: false,
          id: 'b6odmume',
          name: 'sort',
          type: 'number',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            noDecimal: false,
          },
        },
        {
          system: false,
          id: 'tvl368vs',
          name: 'isDefault',
          type: 'bool',
          required: false,
          presentable: false,
          unique: false,
          options: {},
        },
        {
          system: false,
          id: 'zqfwhhve',
          name: 'label',
          type: 'text',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
        {
          system: false,
          id: 'yp7cwnuv',
          name: 'active',
          type: 'bool',
          required: false,
          presentable: false,
          unique: false,
          options: {},
        },
      ],
      indexes: [],
      listRule: '',
      viewRule: '',
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {},
    },
    {
      id: 'bujm8joyamo70hu',
      name: 'HcPages',
      type: 'base',
      system: false,
      schema: [
        {
          system: false,
          id: '8m2xzxp0',
          name: 'name',
          type: 'text',
          required: false,
          presentable: true,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
        {
          system: false,
          id: 'xmleo7z7',
          name: 'sort',
          type: 'number',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            noDecimal: false,
          },
        },
        {
          system: false,
          id: 'npb031bw',
          name: 'show',
          type: 'select',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSelect: 1,
            values: ['always', 'active', 'never'],
          },
        },
        {
          system: false,
          id: '8qnoj0tp',
          name: 'Parent',
          type: 'relation',
          required: false,
          presentable: false,
          unique: false,
          options: {
            collectionId: 'bujm8joyamo70hu',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: [],
          },
        },
        {
          system: false,
          id: '7g5epwif',
          name: 'resolveSlug',
          type: 'bool',
          required: false,
          presentable: false,
          unique: false,
          options: {},
        },
        {
          system: false,
          id: '8hdhdi93',
          name: 'active',
          type: 'bool',
          required: false,
          presentable: false,
          unique: false,
          options: {},
        },
      ],
      indexes: [],
      listRule: '',
      viewRule: '',
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {},
    },
    {
      id: 'h8s02t2mdppb6ik',
      name: 'HcPagesLang',
      type: 'base',
      system: false,
      schema: [
        {
          system: false,
          id: '6eyccnap',
          name: 'Page',
          type: 'relation',
          required: false,
          presentable: false,
          unique: false,
          options: {
            collectionId: 'bujm8joyamo70hu',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: [],
          },
        },
        {
          system: false,
          id: 'vzxsnkhh',
          name: 'Lang',
          type: 'relation',
          required: false,
          presentable: false,
          unique: false,
          options: {
            collectionId: '09zlcfzxr29yom7',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: [],
          },
        },
        {
          system: false,
          id: 'x5vqclnk',
          name: 'slug',
          type: 'text',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
        {
          system: false,
          id: 'punuyabq',
          name: 'label',
          type: 'text',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
        {
          system: false,
          id: '3swh5i5v',
          name: 'Content',
          type: 'relation',
          required: false,
          presentable: false,
          unique: false,
          options: {
            collectionId: 'br1inx9nr82mah7',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: [],
          },
        },
      ],
      indexes: [],
      listRule: '',
      viewRule: '',
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {},
    },
    {
      id: 'uponta6pnjmy6yw',
      name: 'HcTeasers',
      type: 'base',
      system: false,
      schema: [
        {
          system: false,
          id: 'e5aa8sjq',
          name: 'Page',
          type: 'relation',
          required: false,
          presentable: true,
          unique: false,
          options: {
            collectionId: 'bujm8joyamo70hu',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: ['name'],
          },
        },
        {
          system: false,
          id: 'tvmfvdki',
          name: 'activeFrom',
          type: 'date',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: '',
            max: '',
          },
        },
        {
          system: false,
          id: 'qfwefoph',
          name: 'activeTo',
          type: 'date',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: '',
            max: '',
          },
        },
        {
          system: false,
          id: 'sw0jyekj',
          name: 'slugValue',
          type: 'text',
          required: false,
          presentable: true,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
      ],
      indexes: [],
      listRule: '',
      viewRule: '',
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {},
    },
    {
      id: 'q89vcgmwdnews1v',
      name: 'HcTeasersLang',
      type: 'base',
      system: false,
      schema: [
        {
          system: false,
          id: 'htbvj8qb',
          name: 'Teaser',
          type: 'relation',
          required: false,
          presentable: false,
          unique: false,
          options: {
            collectionId: 'uponta6pnjmy6yw',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: [],
          },
        },
        {
          system: false,
          id: '6evejguo',
          name: 'Lang',
          type: 'relation',
          required: false,
          presentable: false,
          unique: false,
          options: {
            collectionId: '09zlcfzxr29yom7',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: [],
          },
        },
        {
          system: false,
          id: 'cuv3mxkz',
          name: 'Content',
          type: 'relation',
          required: false,
          presentable: false,
          unique: false,
          options: {
            collectionId: 'br1inx9nr82mah7',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: [],
          },
        },
        {
          system: false,
          id: '4pv7qgsq',
          name: 'title',
          type: 'text',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
        {
          system: false,
          id: '1he0v5mx',
          name: 'description',
          type: 'text',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
        {
          system: false,
          id: 'xg4kvkz1',
          name: 'linkLabel',
          type: 'text',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
        {
          system: false,
          id: 'svxt0cp4',
          name: 'tags',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 2000000,
          },
        },
        {
          system: false,
          id: 'gsclktcd',
          name: 'Image',
          type: 'file',
          required: false,
          presentable: false,
          unique: false,
          options: {
            mimeTypes: [
              'image/jpeg',
              'image/png',
              'image/svg+xml',
              'image/gif',
              'image/webp',
            ],
            thumbs: ['480x720'],
            maxSelect: 1,
            maxSize: 5242880,
            protected: false,
          },
        },
      ],
      indexes: [],
      listRule: '',
      viewRule: '',
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {},
    },
    {
      id: 'q60mgarih7dy0ij',
      name: 'HcTeasersTargets',
      type: 'base',
      system: false,
      schema: [
        {
          system: false,
          id: 'bjtddfwf',
          name: 'Teaser',
          type: 'relation',
          required: false,
          presentable: false,
          unique: false,
          options: {
            collectionId: 'uponta6pnjmy6yw',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: ['Page', 'slugValue'],
          },
        },
        {
          system: false,
          id: 'yfvci23g',
          name: 'Page',
          type: 'relation',
          required: false,
          presentable: false,
          unique: false,
          options: {
            collectionId: 'bujm8joyamo70hu',
            cascadeDelete: false,
            minSelect: null,
            maxSelect: 1,
            displayFields: [],
          },
        },
        {
          system: false,
          id: '1fwqs7wm',
          name: 'slugValue',
          type: 'text',
          required: false,
          presentable: false,
          unique: false,
          options: {
            min: null,
            max: null,
            pattern: '',
          },
        },
      ],
      indexes: [],
      listRule: '',
      viewRule: '',
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {},
    },
    {
      id: 'bhqxj7f15y4cgkp',
      name: 'HcNavigation',
      type: 'view',
      system: false,
      schema: [
        {
          system: false,
          id: 'fw4eij5t',
          name: 'name',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 1,
          },
        },
        {
          system: false,
          id: 'ieu86o46',
          name: 'sort',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 1,
          },
        },
        {
          system: false,
          id: 'vigrgtu6',
          name: 'show',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 1,
          },
        },
        {
          system: false,
          id: 'euvecxrq',
          name: 'resolveSlug',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 1,
          },
        },
        {
          system: false,
          id: '5zm19onj',
          name: 'lang',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 1,
          },
        },
        {
          system: false,
          id: '9k1hyaaw',
          name: 'langCode',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 1,
          },
        },
        {
          system: false,
          id: 't4jnotjx',
          name: 'path',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 1,
          },
        },
        {
          system: false,
          id: 'n79xfobc',
          name: 'sortedPath',
          type: 'json',
          required: false,
          presentable: false,
          unique: false,
          options: {
            maxSize: 1,
          },
        },
      ],
      indexes: [],
      listRule: '',
      viewRule: '',
      createRule: null,
      updateRule: null,
      deleteRule: null,
      options: {
        query:
          "WITH RECURSIVE Navigation AS (\n  SELECT\n    p.id AS id,\n    p.name,\n    p.sort,\n    p.show,\n    p.resolveSlug,\n    pl.Lang,\n    pl.label,\n    l.code AS langCode,\n    ('/' || l.code) AS path,\n    ('/' || l.code) AS sortedPath\n  FROM HcPages AS p\n    JOIN HcPagesLang AS pl ON pl.Page = p.id\n    JOIN HcLangs AS l ON l.id = pl.Lang\n    WHERE p.Parent = '' AND l.active = TRUE\n  UNION\n  SELECT\n    p.id AS id,\n    p.name,\n    p.sort,\n    p.show,\n    p.resolveSlug,\n    pl.Lang,\n    pl.label,\n    l.code AS langCode,\n    (n.path || '/' || pl.slug) AS path,\n    (n.path || '/' || (p.sort + 1) || '.' || pl.slug) AS sortedPath\n  FROM HcPages AS p\n\tJOIN Navigation AS n ON p.Parent = n.id\n    JOIN HcPagesLang As pl ON pl.Page = p.id\n    JOIN HcLangs As l ON l.id = pl.Lang\n   WHERE pl.Lang = n.Lang\n)\nSELECT id, name, sort, show, resolveSlug, Lang AS lang, langCode, path, sortedPath FROM Navigation ORDER BY Lang, path;",
      },
    },
  ]

  for (const collectionDef of collectionDefs) {
    const collection = new Collection(collectionDef)
    dao.saveCollection(collection)
  }

  // Add some contents
  const HcPages = dao.findCollectionByNameOrId('HcPages')
  const HcLangs = dao.findCollectionByNameOrId('HcLangs')
  const HcContents = dao.findCollectionByNameOrId('HcContents')
  const HcPagesLang = dao.findCollectionByNameOrId('HcPagesLang')

  const homePage = new Record(HcPages, {
    name: 'home',
    sort: 0,
    show: 'always',
    resolveSlug: false,
    active: true,
  })
  dao.saveRecord(homePage)
  const contactPage = new Record(HcPages, {
    name: 'contact',
    sort: 10,
    show: 'always',
    resolveSlug: false,
    active: true,
    Parent: homePage.id,
  })
  dao.saveRecord(contactPage)

  const frLang = new Record(HcLangs, {
    code: 'fr',
    sort: 0,
    isDefault: true,
    label: 'Français',
    active: true,
  })
  dao.saveRecord(frLang)
  const enLang = new Record(HcLangs, {
    code: 'en',
    sort: 0,
    isDefault: false,
    label: 'English',
    active: true,
  })
  dao.saveRecord(enLang)

  const homeFrContent = new Record(HcContents, {
    blocks: JSON.stringify([]),
    state: 'published',
    editorVersion: '2.26.5',
    name: '',
  })
  dao.saveRecord(homeFrContent)
  const homeEnContent = new Record(HcContents, {
    blocks: JSON.stringify([]),
    state: 'published',
    editorVersion: '2.26.5',
    name: '',
  })
  dao.saveRecord(homeEnContent)
  const contactFrContent = new Record(HcContents, {
    blocks: JSON.stringify([]),
    state: 'published',
    editorVersion: '2.26.5',
    name: '',
  })
  dao.saveRecord(contactFrContent)
  const contactEnContent = new Record(HcContents, {
    blocks: JSON.stringify([]),
    state: 'published',
    editorVersion: '2.26.5',
    name: '',
  })
  dao.saveRecord(contactEnContent)

  const homePageFr = new Record(HcPagesLang, {
    Page: homePage.id,
    Lang: frLang.id,
    slug: '',
    label: 'Hypercontent - Accueil',
    Content: homeFrContent.id,
  })
  dao.saveRecord(homePageFr)
  const homePageEn = new Record(HcPagesLang, {
    Page: homePage.id,
    Lang: enLang.id,
    slug: '',
    label: 'Hypercontent - Welcome',
    Content: homeEnContent.id,
  })
  dao.saveRecord(homePageEn)
  const contactPageFr = new Record(HcPagesLang, {
    Page: contactPage.id,
    Lang: frLang.id,
    slug: 'contactez-nous',
    label: 'Hypercontent - Contactez-nous!',
    Content: contactFrContent.id,
  })
  dao.saveRecord(contactPageFr)
  const contactPageEn = new Record(HcPagesLang, {
    Page: contactPage.id,
    Lang: enLang.id,
    slug: 'contact-us',
    label: 'Hypercontent - Contact us!',
    Content: contactEnContent.id,
  })
  dao.saveRecord(contactPageEn)
})
